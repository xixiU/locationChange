name: Release Build

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·'
        required: true
        default: '1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜Ž'
        required: false
        default: 'æ–°ç‰ˆæœ¬å‘å¸ƒ'

jobs:
  prepare-release:
    name: å‡†å¤‡å‘å¸ƒ
    runs-on: macos-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION="${{ github.event.release.tag_name }}"
          VERSION=${VERSION#v} # ç§»é™¤vå‰ç¼€
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        
        BUILD_NUMBER=$(date +%Y%m%d%H%M)
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        
        echo "ðŸ“± ç‰ˆæœ¬ä¿¡æ¯:"
        echo "ç‰ˆæœ¬å·: $VERSION"
        echo "æž„å»ºå·: $BUILD_NUMBER"
        
    - name: æ›´æ–°é¡¹ç›®ç‰ˆæœ¬
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        BUILD_NUMBER="${{ steps.version.outputs.build_number }}"
        
        # æ›´æ–°Info.plistä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" LocationChanger/Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" LocationChanger/Info.plist
        
        echo "âœ… ç‰ˆæœ¬ä¿¡æ¯å·²æ›´æ–°"
        
    - name: æäº¤ç‰ˆæœ¬æ›´æ–°
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add LocationChanger/Info.plist
        git commit -m "chore: æ›´æ–°ç‰ˆæœ¬åˆ° ${{ steps.version.outputs.version }} (æž„å»ºå·: ${{ steps.version.outputs.build_number }})" || echo "æ— éœ€æäº¤"
        
  build-release:
    name: æž„å»ºå‘å¸ƒç‰ˆæœ¬
    runs-on: macos-latest
    needs: prepare-release
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0'
        
    - name: ç¼“å­˜æž„å»ºä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.spm
        key: ${{ runner.os }}-xcode-${{ hashFiles('**/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-xcode-
          
    - name: æž„å»ºReleaseç‰ˆæœ¬
      run: |
        echo "ðŸ”¨ å¼€å§‹æž„å»ºReleaseç‰ˆæœ¬..."
        
        xcodebuild clean build \
          -project LocationChanger.xcodeproj \
          -scheme LocationChanger \
          -configuration Release \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=18.0' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty
          
        if [ $? -eq 0 ]; then
          echo "âœ… Releaseç‰ˆæœ¬æž„å»ºæˆåŠŸï¼"
        else
          echo "âŒ Releaseç‰ˆæœ¬æž„å»ºå¤±è´¥ï¼"
          exit 1
        fi
        
    - name: åˆ›å»ºå½’æ¡£
      run: |
        echo "ðŸ“¦ åˆ›å»ºé¡¹ç›®å½’æ¡£..."
        
        # åˆ›å»ºæºç åŒ…
        zip -r LocationChanger-Source-${{ needs.prepare-release.outputs.version }}.zip \
          LocationChanger/ \
          LocationChanger.xcodeproj/ \
          README.md \
          .github/ \
          -x "*/DerivedData/*" "*/build/*" "*/.DS_Store"
          
        echo "âœ… æºç åŒ…åˆ›å»ºå®Œæˆ"
        
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      run: |
        cat > RELEASE_NOTES.md << EOF
        # è™šæ‹Ÿå®šä½ v${{ needs.prepare-release.outputs.version }}
        
        ## ðŸ“± åº”ç”¨ä¿¡æ¯
        - **ç‰ˆæœ¬å·**: ${{ needs.prepare-release.outputs.version }}
        - **æž„å»ºå·**: ${{ needs.prepare-release.outputs.build_number }}
        - **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
        - **iOSæœ€ä½Žç‰ˆæœ¬**: 18.0
        
        ## ðŸŽ¯ ä¸»è¦åŠŸèƒ½
        - âœ… è™šæ‹Ÿå®šä½è®¾ç½®å’Œåˆ‡æ¢
        - âœ… åœ°å›¾äº¤äº’å’Œä½ç½®é€‰æ‹©
        - âœ… æ™ºèƒ½ä½ç½®æœç´¢åŠŸèƒ½
        - âœ… é¢„è®¾çƒ­é—¨ä½ç½®
        - âœ… åŽ†å²è®°å½•ç®¡ç†
        - âœ… æ”¶è—ä½ç½®åŠŸèƒ½
        - âœ… ä¸ªæ€§åŒ–è®¾ç½®é€‰é¡¹
        
        ## ðŸ“‹ æŠ€æœ¯ç‰¹æ€§
        - ðŸŽ¨ çŽ°ä»£åŒ–iOSç•Œé¢è®¾è®¡
        - ðŸ—ºï¸ MapKitåœ°å›¾é›†æˆ
        - ðŸ“ CoreLocationå®šä½æœåŠ¡
        - ðŸ’¾ æœ¬åœ°æ•°æ®æŒä¹…åŒ–
        - ðŸ”’ ä½ç½®æƒé™ç®¡ç†
        
        ## ðŸ“¥ å®‰è£…è¯´æ˜Ž
        1. ä¸‹è½½æºç åŒ…
        2. ä½¿ç”¨Xcode 16.0+æ‰“å¼€é¡¹ç›®
        3. è¿žæŽ¥iOSè®¾å¤‡æˆ–é€‰æ‹©æ¨¡æ‹Ÿå™¨
        4. ç‚¹å‡»è¿è¡ŒæŒ‰é’®è¿›è¡Œå®‰è£…
        
        ## âš ï¸ é‡è¦æé†’
        æœ¬åº”ç”¨ä»…ä¾›å¼€å‘æµ‹è¯•ä½¿ç”¨ï¼Œè¯·å‹¿ç”¨äºŽè¿æ³•ç”¨é€”ã€‚ä½¿ç”¨å‰è¯·äº†è§£ç›¸å…³æ³•å¾‹æ³•è§„ã€‚
        
        ---
        
        ${{ github.event.inputs.release_notes || github.event.release.body || 'æ–°ç‰ˆæœ¬å‘å¸ƒ' }}
        EOF
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: LocationChanger-Release-${{ needs.prepare-release.outputs.version }}
        path: |
          LocationChanger-Source-${{ needs.prepare-release.outputs.version }}.zip
          RELEASE_NOTES.md
        retention-days: 90
        
    - name: åˆ›å»ºGitHub Release (å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘)
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.prepare-release.outputs.version }}
        name: è™šæ‹Ÿå®šä½ v${{ needs.prepare-release.outputs.version }}
        body_path: RELEASE_NOTES.md
        files: |
          LocationChanger-Source-${{ needs.prepare-release.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  notify-release:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release]
    if: always()
    
    steps:
    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      if: needs.build-release.result == 'success'
      run: |
        echo "ðŸŽ‰ è™šæ‹Ÿå®šä½åº”ç”¨å‘å¸ƒæˆåŠŸï¼"
        echo ""
        echo "ðŸ“± ç‰ˆæœ¬ä¿¡æ¯:"
        echo "ç‰ˆæœ¬å·: ${{ needs.prepare-release.outputs.version }}"
        echo "æž„å»ºå·: ${{ needs.prepare-release.outputs.build_number }}"
        echo "å‘å¸ƒæ—¶é—´: $(date)"
        echo ""
        echo "ðŸ”— ä¸‹è½½é“¾æŽ¥:"
        echo "GitHub Releases: https://github.com/${{ github.repository }}/releases"
        echo ""
        echo "ðŸ“– ä½¿ç”¨è¯´æ˜Ž:"
        echo "è¯·æŸ¥çœ‹README.mdæ–‡ä»¶èŽ·å–è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜Žå’Œå®‰è£…æŒ‡å—"
        
    - name: å‘å¸ƒå¤±è´¥é€šçŸ¥
      if: needs.build-release.result == 'failure'
      run: |
        echo "âŒ è™šæ‹Ÿå®šä½åº”ç”¨å‘å¸ƒå¤±è´¥ï¼"
        echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"