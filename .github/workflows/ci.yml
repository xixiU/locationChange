name: Continuous Integration

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-build:
    name: Code Quality & Build Check
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Xcodeç‰ˆæœ¬
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.0'
        
    - name: æ£€æŸ¥é¡¹ç›®ç»“æ„
      run: |
        echo "ğŸ“ æ£€æŸ¥é¡¹ç›®æ–‡ä»¶ç»“æ„..."
        ls -la
        echo ""
        echo "ğŸ“± æ£€æŸ¥iOSé¡¹ç›®æ–‡ä»¶..."
        ls -la LocationChanger/
        echo ""
        echo "ğŸ” æ£€æŸ¥é¡¹ç›®é…ç½®..."
        if [ -f "LocationChanger.xcodeproj/project.pbxproj" ]; then
          echo "âœ… æ‰¾åˆ°Xcodeé¡¹ç›®æ–‡ä»¶"
        else
          echo "âŒ æœªæ‰¾åˆ°Xcodeé¡¹ç›®æ–‡ä»¶"
          exit 1
        fi
        
    - name: Swiftä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "ğŸ” æ£€æŸ¥Swiftä»£ç æ ¼å¼..."
        find LocationChanger -name "*.swift" -exec echo "æ£€æŸ¥æ–‡ä»¶: {}" \;
        
        # æ£€æŸ¥åŸºæœ¬çš„ä»£ç è´¨é‡
        echo ""
        echo "ğŸ“Š ä»£ç ç»Ÿè®¡:"
        find LocationChanger -name "*.swift" | wc -l | xargs echo "Swiftæ–‡ä»¶æ•°é‡:"
        find LocationChanger -name "*.swift" -exec wc -l {} + | tail -1 | awk '{print $1}' | xargs echo "æ€»ä»£ç è¡Œæ•°:"
        
    - name: é¡¹ç›®ç¼–è¯‘æ£€æŸ¥
      run: |
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘æ£€æŸ¥..."
        xcodebuild clean build \
          -project LocationChanger.xcodeproj \
          -scheme LocationChanger \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=18.0' \
          -configuration Debug \
          -quiet \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
          
        if [ $? -eq 0 ]; then
          echo "âœ… é¡¹ç›®ç¼–è¯‘æˆåŠŸï¼"
        else
          echo "âŒ é¡¹ç›®ç¼–è¯‘å¤±è´¥ï¼"
          exit 1
        fi
        
    - name: è¯­æ³•æ£€æŸ¥
      run: |
        echo "ğŸ“ æ‰§è¡ŒSwiftè¯­æ³•æ£€æŸ¥..."
        find LocationChanger -name "*.swift" -print0 | xargs -0 xcrun swift -frontend -parse
        
        if [ $? -eq 0 ]; then
          echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼"
        else
          echo "âŒ å‘ç°è¯­æ³•é”™è¯¯ï¼"
          exit 1
        fi
        
    - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      if: always()
      run: |
        echo "ğŸ“‹ æ„å»ºæŠ¥å‘Š"
        echo "=================="
        echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "æ„å»ºæ—¶é—´: $(date)"
        echo ""
        echo "ğŸ“± é¡¹ç›®ä¿¡æ¯:"
        echo "é¡¹ç›®åç§°: LocationChanger (è™šæ‹Ÿå®šä½)"
        echo "iOSæœ€ä½ç‰ˆæœ¬: 17.0"
        echo "Xcodeç‰ˆæœ¬: 15.0"
        echo ""
        echo "ğŸ¯ åŠŸèƒ½æ¨¡å—:"
        echo "- âœ… è™šæ‹Ÿå®šä½æ ¸å¿ƒåŠŸèƒ½"
        echo "- âœ… åœ°å›¾é›†æˆ"
        echo "- âœ… ä½ç½®æœç´¢"
        echo "- âœ… å†å²è®°å½•å’Œæ”¶è—"
        echo "- âœ… è®¾ç½®ç•Œé¢"
        
  security-check:
    name: å®‰å…¨æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
      run: |
        echo "ğŸ”’ æ£€æŸ¥ä»£ç ä¸­çš„æ•æ„Ÿä¿¡æ¯..."
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡¬ç¼–ç çš„APIå¯†é’¥æˆ–å¯†ç 
        if grep -r -i "password\|api.key\|secret\|token" LocationChanger/ --include="*.swift" --exclude-dir=".git"; then
          echo "âš ï¸  å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥æ˜¯å¦ä¸ºç¡¬ç¼–ç çš„å¯†é’¥"
        else
          echo "âœ… æœªå‘ç°æ˜æ˜¾çš„æ•æ„Ÿä¿¡æ¯"
        fi
        
        # æ£€æŸ¥æƒé™é…ç½®
        echo ""
        echo "ğŸ›¡ï¸ æ£€æŸ¥æƒé™é…ç½®..."
        if grep -q "NSLocationWhenInUseUsageDescription" LocationChanger/Info.plist; then
          echo "âœ… ä½ç½®æƒé™é…ç½®æ­£ç¡®"
        else
          echo "âŒ ç¼ºå°‘ä½ç½®æƒé™é…ç½®"
        fi
        
    - name: ä»£ç è´¨é‡è¯„ä¼°
      run: |
        echo "ğŸ“Š ä»£ç è´¨é‡è¯„ä¼°..."
        
        # è®¡ç®—ä»£ç å¤æ‚åº¦æŒ‡æ ‡
        swift_files=$(find LocationChanger -name "*.swift" | wc -l)
        total_lines=$(find LocationChanger -name "*.swift" -exec wc -l {} + | tail -1 | awk '{print $1}')
        avg_lines=$((total_lines / swift_files))
        
        echo "æ–‡ä»¶æ•°é‡: $swift_files"
        echo "æ€»è¡Œæ•°: $total_lines"
        echo "å¹³å‡æ¯æ–‡ä»¶è¡Œæ•°: $avg_lines"
        
        if [ $avg_lines -gt 500 ]; then
          echo "âš ï¸  æŸäº›æ–‡ä»¶å¯èƒ½è¿‡å¤§ï¼Œå»ºè®®é‡æ„"
        else
          echo "âœ… æ–‡ä»¶å¤§å°åˆç†"
        fi